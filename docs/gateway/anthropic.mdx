---
sidebar_position: 2
title: Anthropic (Claude)
description: Monitor Claude models through TrustScope - Claude 3.5 Sonnet, Claude 3 Opus, Haiku, and more
---

# Anthropic (Claude) Integration

TrustScope provides full support for Anthropic's Claude models through both the **Gateway proxy** and **Python/Node.js SDKs**.

## Supported Models

| Model | Model ID | Context | Best For |
|-------|----------|---------|----------|
| Claude 3.5 Sonnet | `claude-3-5-sonnet-20241022` | 200K | Coding, analysis, agents |
| Claude 3 Opus | `claude-3-opus-20240229` | 200K | Complex reasoning |
| Claude 3 Sonnet | `claude-3-sonnet-20240229` | 200K | Balanced performance |
| Claude 3 Haiku | `claude-3-haiku-20240307` | 200K | Fast, cost-effective |
| Claude 2.1 | `claude-2.1` | 100K | Legacy support |

---

## Gateway Integration

### Python SDK

```python
from anthropic import Anthropic

client = Anthropic(
    base_url="https://gateway.trustscope.ai/anthropic",
    default_headers={"X-TrustScope-Key": "ts_live_xxx"}
)

# Standard Messages API
response = client.messages.create(
    model="claude-3-5-sonnet-20241022",
    max_tokens=1024,
    messages=[
        {"role": "user", "content": "Explain quantum computing in simple terms"}
    ]
)

print(response.content[0].text)
```

### Node.js SDK

```typescript
import Anthropic from '@anthropic-ai/sdk';

const client = new Anthropic({
  baseURL: 'https://gateway.trustscope.ai/anthropic',
  defaultHeaders: { 'X-TrustScope-Key': 'ts_live_xxx' }
});

const response = await client.messages.create({
  model: 'claude-3-5-sonnet-20241022',
  max_tokens: 1024,
  messages: [
    { role: 'user', content: 'Explain quantum computing in simple terms' }
  ]
});

console.log(response.content[0].text);
```

### cURL

```bash
curl https://gateway.trustscope.ai/anthropic/v1/messages \
  -H "x-api-key: $ANTHROPIC_API_KEY" \
  -H "X-TrustScope-Key: ts_live_xxx" \
  -H "anthropic-version: 2023-06-01" \
  -H "Content-Type: application/json" \
  -d '{
    "model": "claude-3-5-sonnet-20241022",
    "max_tokens": 1024,
    "messages": [
      {"role": "user", "content": "Explain quantum computing"}
    ]
  }'
```

---

## Streaming

```python
# Streaming with context manager
with client.messages.stream(
    model="claude-3-5-sonnet-20241022",
    max_tokens=1024,
    messages=[{"role": "user", "content": "Write a story"}]
) as stream:
    for text in stream.text_stream:
        print(text, end="", flush=True)
```

```typescript
// Node.js streaming
const stream = await client.messages.stream({
  model: 'claude-3-5-sonnet-20241022',
  max_tokens: 1024,
  messages: [{ role: 'user', content: 'Write a story' }]
});

for await (const event of stream) {
  if (event.type === 'content_block_delta') {
    process.stdout.write(event.delta.text);
  }
}
```

---

## Tool Use (Function Calling)

TrustScope captures tool use calls and results:

```python
response = client.messages.create(
    model="claude-3-5-sonnet-20241022",
    max_tokens=1024,
    tools=[
        {
            "name": "get_weather",
            "description": "Get weather for a location",
            "input_schema": {
                "type": "object",
                "properties": {
                    "location": {"type": "string"}
                },
                "required": ["location"]
            }
        }
    ],
    messages=[
        {"role": "user", "content": "What's the weather in Paris?"}
    ]
)

# TrustScope captures:
# - Tool definition
# - Tool invocation request
# - Tool result (when you send it back)
```

---

## Vision (Images)

```python
import base64

# Local image
with open("image.png", "rb") as f:
    image_data = base64.standard_b64encode(f.read()).decode("utf-8")

response = client.messages.create(
    model="claude-3-5-sonnet-20241022",
    max_tokens=1024,
    messages=[
        {
            "role": "user",
            "content": [
                {
                    "type": "image",
                    "source": {
                        "type": "base64",
                        "media_type": "image/png",
                        "data": image_data
                    }
                },
                {
                    "type": "text",
                    "text": "What's in this image?"
                }
            ]
        }
    ]
)
```

:::note Image Logging
By default, TrustScope logs image metadata (size, type) but not the full image data. Enable full image logging in your policy settings if needed for audit purposes.
:::

---

## System Prompts

```python
response = client.messages.create(
    model="claude-3-5-sonnet-20241022",
    max_tokens=1024,
    system="You are a helpful customer support agent for Acme Corp.",
    messages=[
        {"role": "user", "content": "How do I reset my password?"}
    ]
)
```

---

## Extended Thinking (Claude 3.5)

```python
response = client.messages.create(
    model="claude-3-5-sonnet-20241022",
    max_tokens=16000,
    thinking={
        "type": "enabled",
        "budget_tokens": 10000
    },
    messages=[
        {"role": "user", "content": "Solve this complex math problem..."}
    ]
)

# Access thinking content
for block in response.content:
    if block.type == "thinking":
        print(f"Thinking: {block.thinking}")
    elif block.type == "text":
        print(f"Response: {block.text}")
```

---

## Computer Use (Beta)

TrustScope monitors computer use actions for security:

```python
response = client.messages.create(
    model="claude-3-5-sonnet-20241022",
    max_tokens=4096,
    tools=[
        {
            "type": "computer_20241022",
            "name": "computer",
            "display_width_px": 1024,
            "display_height_px": 768,
            "display_number": 1
        }
    ],
    messages=[
        {"role": "user", "content": "Open the browser and go to google.com"}
    ]
)
```

:::warning Computer Use Detection
TrustScope's **Command Firewall** detection engine monitors computer use actions. Configure allowed/blocked actions in your policies.
:::

---

## Agent Identity

Track which Claude-based agent made each request:

```python
client = Anthropic(
    base_url="https://gateway.trustscope.ai/anthropic",
    default_headers={
        "X-TrustScope-Key": "ts_live_xxx",
        "X-TrustScope-Agent-Id": "customer-support-agent",
        "X-TrustScope-Session-Id": "session_abc123"
    }
)
```

---

## Cost Tracking

TrustScope automatically tracks costs for all Claude models:

| Model | Input (per 1M tokens) | Output (per 1M tokens) |
|-------|----------------------|------------------------|
| Claude 3.5 Sonnet | $3.00 | $15.00 |
| Claude 3 Opus | $15.00 | $75.00 |
| Claude 3 Sonnet | $3.00 | $15.00 |
| Claude 3 Haiku | $0.25 | $1.25 |

Costs are calculated automatically and shown in:
- Individual trace details
- Dashboard cost analytics
- Monthly billing reports

---

## Anthropic-Specific Headers

| Header | Required | Description |
|--------|----------|-------------|
| `x-api-key` | ✅ | Your Anthropic API key |
| `anthropic-version` | ✅ | API version (use `2023-06-01`) |
| `anthropic-beta` | Optional | Enable beta features |
| `X-TrustScope-Key` | ✅ | Your TrustScope API key |

---

## Error Handling

```python
from anthropic import APIError, RateLimitError

try:
    response = client.messages.create(
        model="claude-3-5-sonnet-20241022",
        max_tokens=1024,
        messages=[{"role": "user", "content": "Hello"}]
    )
except RateLimitError:
    # Handle rate limiting
    print("Rate limited, retrying...")
except APIError as e:
    # TrustScope adds context to errors
    print(f"API error: {e}")
```

---

## Troubleshooting

### "Invalid API Key"
- Ensure `x-api-key` header contains your Anthropic API key
- Check the key is active in the Anthropic Console

### "Missing anthropic-version header"
```python
# Always include the version header
client = Anthropic(
    base_url="https://gateway.trustscope.ai/anthropic",
    default_headers={
        "X-TrustScope-Key": "ts_live_xxx",
        "anthropic-version": "2023-06-01"  # Required
    }
)
```

### Streaming not working
- Ensure you're using `.stream()` or `.messages.stream()` 
- Check for firewall/proxy issues with SSE connections

---

## Next Steps

- [Add Policies](/docs/concepts/policies) - Configure content filters for Claude
- [LangChain + Claude](/docs/frameworks/langchain) - Use Claude with LangChain
- [CrewAI + Claude](/docs/frameworks/crewai) - Build multi-agent systems
